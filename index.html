<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pair Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background-color: #f2f2f2;
      color: #000000;
    }

    .page-wrapper {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 16px 48px;
    }

    h1 {
      margin-top: 0;
      margin-bottom: 24px;
      font-size: 28px;
      font-weight: 600;
    }

    .columns {
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
    }

    .left-column {
      width: 50%;
      padding-right: 16px;
    }

    .right-column {
      width: 50%;
      padding-left: 16px;
    }

    .card {
      background-color: #ffffff;
      border-radius: 14px;
      padding: 20px 24px 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #d0d0d0;
      background-color: #fafafa;
      color: inherit;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        background-color 0.15s ease;
    }

    input[type="text"]:focus,
    select:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.15);
      background-color: #ffffff;
    }

    .field-group {
      margin-bottom: 14px;
    }

    .status-message {
      margin-top: 6px;
      font-size: 14px;
      font-weight: 500;
    }

    .status-success {
      color: #2e7d32; /* green */
    }

    .status-error {
      color: #b71c1c; /* dark red */
    }

    .selectors-row {
      display: flex;
      gap: 10px;
      margin-bottom: 14px;
    }

    .selectors-row > div {
      flex: 1;
    }

    .actions-row {
      margin-top: 6px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.15s ease, transform 0.05s ease,
        box-shadow 0.15s ease;
    }

    button:active:not(:disabled) {
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2) inset;
    }

    #guessButton {
      background-color: #c9c9c9;
      color: #444444;
      cursor: not-allowed;
    }

    #guessButton.enabled {
      background-color: #007bff;
      color: #ffffff;
      cursor: pointer;
    }

    #guessButton.enabled:hover {
      background-color: #0064cc;
    }

    #validateButton {
      background-color: #c9c9c9;
      color: #444444;
      cursor: not-allowed;
    }

    #validateButton:enabled {
      background-color: #28a745;
      color: #ffffff;
      cursor: pointer;
    }

    #validateButton:enabled:hover {
      background-color: #218838;
    }

    .helper-text {
      font-size: 12px;
      color: #666666;
      margin-top: 4px;
    }

    .refresh-button {
      background-color: #007bff;
      color: #ffffff;
      cursor: pointer;
      margin-bottom: 16px;
    }

    .refresh-button:hover {
      background-color: #0064cc;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 12px;
    }

    .data-table th {
      background-color: #d3d3d3;
      padding: 8px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
      border: 1px solid #c0c0c0;
    }

    .data-table td {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #e0e0e0;
    }

    .last-refreshed {
      font-size: 12px;
      color: #4a4a4a;
      margin-top: 8px;
    }

    .table-placeholder {
      font-size: 14px;
      color: #666666;
      padding: 16px 0;
      text-align: center;
    }

    @media (max-width: 900px) {
      .columns {
        flex-direction: column;
      }
      .left-column {
        width: 100%;
        padding-right: 0;
      }
      .right-column {
        width: 100%;
        padding-left: 0;
      }
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <h1>Pair Checker</h1>

    <div class="columns">
      <div class="left-column">
        <!-- Card 1: One-Time Use Code -->
        <div class="card">
          <div class="card-title">One-Time Use Code</div>

          <div class="field-group">
            <input
              type="text"
              id="codeInput"
              autocomplete="off"
              placeholder="Enter your one-time use code"
              maxlength="15"
            />
            <div id="codeStatus" class="status-message"></div>
          </div>
          <div class="actions-row">
            <button id="validateButton" disabled>Validate Code</button>
          </div>
        </div>

        <!-- Card 2: Pair Selection -->
        <div class="card">
          <div class="card-title">Pair Selection Checker</div>
          <div class="helper-text" style="margin-bottom: 12px;">
            The button to check your guess is enabled only when a valid code has been verified and
            two different entries are selected.
          </div>

          <div class="selectors-row">
            <div class="field-group">
              <label for="selectOne">Barrel Jack 1</label>
              <select id="selectOne">
                <option value="">— Select —</option>
              </select>
            </div>

            <div class="field-group">
              <label for="selectTwo">Barrel Jack 2</label>
              <select id="selectTwo">
                <option value="">— Select —</option>
              </select>
            </div>
          </div>

          <div class="actions-row">
            <button id="guessButton" disabled>Check Pair</button>
            <div id="guessStatus" class="status-message"></div>
          </div>
        </div>
      </div>

      <!-- Right Column: Check Guesses Remaining -->
      <div class="right-column">
        <div class="card">
          <div class="card-title">Check Guesses Remaining</div>
          
          <button id="refreshDataButton" class="refresh-button">Check Code Use</button>
          
          <div id="tablePlaceholder" class="table-placeholder">
            Click the button to retrieve a record of past code usage.
          </div>
          
          <table class="data-table" id="dataTable" style="display: none;">
            <thead>
              <tr>
                <th>Code</th>
                <th>Date Used</th>
                <th>Item 1</th>
                <th>Item 2</th>
              </tr>
            </thead>
            <tbody id="dataTableBody">
            </tbody>
          </table>
          
          <div id="lastRefreshed" class="last-refreshed" style="display: none;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ================= CONFIGURATION =================
    // Replace this with your deployed Google Apps Script web app URL.
    // Your Apps Script can use e.parameter.action to distinguish actions:
    //   action=validateCode   -> check one-time code and mark used if valid
    //   action=checkPair      -> check whether a given pair is correct
    //
    // Expected JSON responses (examples):
    //   { "result": "valid" }         // for validateCode
    //   { "result": "used" }
    //   { "result": "invalid" }
    //
    //   { "result": "correct" }       // for checkPair
    //   { "result": "incorrect" }
    //
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxnMDgSdw1sVuEthtah32um53br-9qtMgJoPqhEfcq25fFmblazqsN1EFYMjwx7cP47/exec";

    // ================= DATA: WORDS / PHRASES =================
    const entries = [
      "55",
      "1884",
      "6333",
      "(7-5) + (15-7)",
      "05/09/13",
      "19/22/25",
      "23rd",
      "2A Region 3",
      "3 to Broad to 278 to 1",
      "3rd",
      "61%",
      "Aurora",
      "Aximili",
      "Bank of America Plaza",
      "BENTO",
      "Bishop",
      "Brentwood",
      "Cañon City",
      "Canyon",
      "Chuy",
      "Cliff",
      "Colima",
      "Darkwing Duck",
      "December",
      "Deer",
      "Delaware",
      "Delta",
      "Desert Rose",
      "Eagle",
      "Eagles",
      "Egypt",
      "Eiffel 65",
      "Elkhorn",
      "Falcon",
      "Florida",
      "Four-Way Test",
      "Friendsgiving",
      "Gabriel",
      "Game Keeper",
      "Gary",
      "Gator Skater",
      "Gerald Schultz",
      "Goku",
      "Gold H",
      "Harvard",
      "Heiser",
      "Hot Mama's Chilled Ice",
      "Jaquval",
      "Jardin Núñez",
      "Karminee",
      "La-No-Che Rash",
      "LAX",
      "Leak",
      "Let It Be",
      "March",
      "Marlin",
      "McCutcherson",
      "Miles",
      "Mine That Bird",
      "Mississippi",
      "Morès",
      "Mosh Pit",
      "Munson",
      "Oak",
      "PacSun",
      "Panera & Moe's  & Cold Stone",
      "Panther",
      "Penny Lane",
      "Polk",
      "Power 9",
      "Prairie",
      "PS1",
      "Ravnica",
      "Rawlings",
      "Red Alert",
      "Reunion",
      "Robber",
      "Rock Against Bush, Vol. 2",
      "Satarino",
      "Sci-Fi City",
      "Seven Major Changes",
      "Sharky",
      "Silver Moon",
      "Speech",
      "Stump",
      "TAG",
      "Texas",
      "That Is So Cooooooool!",
      "The Beat",
      "Tipisa",
      "Titan",
      "Treaty",
      "Trinity",
      "Trumpet",
      "Virginia",
      "Volcán",
      "Ward",
      "Warrington",
      "Warwick",
      "We Survived the Class of '05",
      "Wicked Game",
      "WOW",
      "Xanga",
      "Yorktown",
      "Zero Miles",
      "Zion"
    ];

    // ================= APP LOGIC =================
    let codeIsValid = false;
    let currentCode = "";

    const codeInput = document.getElementById("codeInput");
    const codeStatus = document.getElementById("codeStatus");
    const validateButton = document.getElementById("validateButton");
    const selectOne = document.getElementById("selectOne");
    const selectTwo = document.getElementById("selectTwo");
    const guessButton = document.getElementById("guessButton");
    const guessStatus = document.getElementById("guessStatus");
    const refreshDataButton = document.getElementById("refreshDataButton");
    const lastRefreshed = document.getElementById("lastRefreshed");

    // Populate both selectors with entries
    function populateSelectors() {
      entries.forEach((item) => {
        const opt1 = document.createElement("option");
        opt1.value = item;
        opt1.textContent = item;
        selectOne.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = item;
        opt2.textContent = item;
        selectTwo.appendChild(opt2);
      });
    }

    function setCodeStatus(message, type) {
      codeStatus.textContent = message || "";
      codeStatus.classList.remove("status-success", "status-error");
      if (type === "success") {
        codeStatus.classList.add("status-success");
      } else if (type === "error") {
        codeStatus.classList.add("status-error");
      }
    }

    function setGuessStatus(message, type) {
      guessStatus.textContent = message || "";
      guessStatus.classList.remove("status-success", "status-error");
      if (type === "success") {
        guessStatus.classList.add("status-success");
      } else if (type === "error") {
        guessStatus.classList.add("status-error");
      }
    }

    // Enable / disable Guess button based on rules
    function updateGuessButtonState() {
      const val1 = selectOne.value;
      const val2 = selectTwo.value;
      const canGuess =
        codeIsValid && val1 && val2 && val1 !== val2;

      guessButton.disabled = !canGuess;
      guessButton.classList.toggle("enabled", canGuess);
    }

    // Check if code is valid 15-digit alphanumeric
    function isValidCodeFormat(code) {
      return /^[a-zA-Z0-9]{15}$/.test(code);
    }

    // Enable / disable Validate button based on code format
    function updateValidateButtonState() {
      const code = codeInput.value.trim();
      validateButton.disabled = !isValidCodeFormat(code);
    }

    // Validate code via Apps Script
    async function validateCode() {
      const code = codeInput.value.trim();
      currentCode = code;
      codeIsValid = false;
      setGuessStatus("", null);
      updateGuessButtonState();

      if (!code) {
        setCodeStatus("", null);
        return;
      }

      try {
        const url =
          SCRIPT_URL +
          "?action=validateCode&code=" +
          encodeURIComponent(code);
        const response = await fetch(url);
        const data = await response.json();

        if (data.result === "valid") {
          codeIsValid = true;
          setCodeStatus("Code validated.", "success");
        } else if (data.result === "used") {
          setCodeStatus(
            "Code previously used. Not valid for use.",
            "error"
          );
        } else {
          setCodeStatus(
            "Code could not be validated. Please try again.",
            "error"
          );
        }
      } catch (err) {
        console.error(err);
        setCodeStatus(
          "There was a problem validating the code. Please try again.",
          "error"
        );
      } finally {
        updateGuessButtonState();
      }
    }

    // Submit a guess via Apps Script
    async function submitGuess() {
      const first = selectOne.value;
      const second = selectTwo.value;

      if (!first || !second || first === second || !codeIsValid) {
        updateGuessButtonState();
        return;
      }

      setGuessStatus("Checking pairing…", null);

      try {
        const url =
          SCRIPT_URL +
          "?action=checkPair&code=" +
          encodeURIComponent(currentCode) +
          "&first=" +
          encodeURIComponent(first) +
          "&second=" +
          encodeURIComponent(second);
        const response = await fetch(url);
        const data = await response.json();

        if (data.result === "correct") {
          setGuessStatus(
            `Correct Pairing: ${first} and ${second}`,
            "success"
          );
        } else if (data.result === "incorrect") {
          setGuessStatus(
            `Incorrect Pairing: ${first} and ${second}`,
            "error"
          );
        } else {
          setGuessStatus(
            "Pair could not be checked. Please try again.",
            "error"
          );
        }
      } catch (err) {
        console.error(err);
        setGuessStatus(
          "There was a problem checking the pairing. Please try again.",
          "error"
        );
      }
    }

    // Refresh data from Google Sheets
    async function refreshData() {
      const tbody = document.getElementById("dataTableBody");
      const dataTable = document.getElementById("dataTable");
      const tablePlaceholder = document.getElementById("tablePlaceholder");

      try {
        const url = SCRIPT_URL + "?action=getTokensData";
        const response = await fetch(url);
        const data = await response.json();

        if (!data || data.result !== "ok" || !Array.isArray(data.rows)) {
          console.error("Unexpected response from getTokensData:", data);
          return;
        }

        // Clear any existing rows
        tbody.innerHTML = "";

        // Build a row for each used token
        data.rows.forEach(row => {
          const [code, dateUsed, item1, item2] = row;
          const tr = document.createElement("tr");

          [code, dateUsed, item1, item2].forEach(cellVal => {
            const td = document.createElement("td");
            td.textContent = cellVal || "";
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });

        // Hide placeholder and show table
        tablePlaceholder.style.display = "none";
        dataTable.style.display = "table";

        // Update the "Last Refreshed" timestamp
        updateLastRefreshedTime();
      } catch (err) {
        console.error("Error refreshing data:", err);
      }
    }

    function updateLastRefreshedTime() {
      const now = new Date();
      const formattedDate = now.toLocaleDateString('en-US', {
        month: '2-digit',
        day: '2-digit',
        year: 'numeric'
      });
      const formattedTime = now.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
      });
      
      lastRefreshed.textContent = `Last Refreshed: ${formattedDate} ${formattedTime}`;
      lastRefreshed.style.display = 'block';
    }

    // ================= EVENT WIRING =================
    document.addEventListener("DOMContentLoaded", () => {
      populateSelectors();

      codeInput.addEventListener("input", () => {
        codeIsValid = false;
        setCodeStatus("", null);
        updateValidateButtonState();
        updateGuessButtonState();
      });

      validateButton.addEventListener("click", (e) => {
        e.preventDefault();
        if (!validateButton.disabled) {
          validateCode();
        }
      });

      selectOne.addEventListener("change", () => {
        setGuessStatus("", null);
        updateGuessButtonState();
      });

      selectTwo.addEventListener("change", () => {
        setGuessStatus("", null);
        updateGuessButtonState();
      });

      guessButton.addEventListener("click", (e) => {
        e.preventDefault();
        if (!guessButton.disabled) {
          submitGuess();
        }
      });

      refreshDataButton.addEventListener("click", (e) => {
        e.preventDefault();
        refreshData();
      });
    });
  </script>
</body>
</html>
